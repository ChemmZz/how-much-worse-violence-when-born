<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>How Much More Violent is Mexico Since You Were Born?</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bulma@1.0.2/css/bulma.min.css" />
    <link href="style.css" rel="stylesheet" />
</head>
<body>
    <div class="intro-section">
        <h1>How Much More Violent is Mexico Since You Were Born?</h1>
        <p>Mexico has experienced sustained violence for years, and people have started to normalize this, 
        desensitized to the daily headlines about another homicide. This is not normal, and I want to 
        show and remind people that ONE homicide is too much.</p>
        
        <div class="selector-box">
            <label for="year-select">When were you born?</label>
            <select id="year-select" name="year-select">
                <option value="" selected disabled>Select year</option>
                <option value="1990">1990</option>
                <option value="1991">1991</option>
                <option value="1992">1992</option>
                <option value="1993">1993</option>
                <option value="1994">1994</option>
                <option value="1995">1995</option>
                <option value="1996">1996</option>
                <option value="1997">1997</option>
                <option value="1998">1998</option>
                <option value="1999">1999</option>
                <option value="2000">2000</option>
                <option value="2001">2001</option>
                <option value="2002">2002</option>
                <option value="2003">2003</option>
                <option value="2004">2004</option>
                <option value="2005">2005</option>
                <option value="2006">2006</option>
                <option value="2007">2007</option>
                <option value="2008">2008</option>
                <option value="2009">2009</option>
                <option value="2010">2010</option>
                <option value="2011">2011</option>
                <option value="2012">2012</option>
                <option value="2013">2013</option>
                <option value="2014">2014</option>
                <option value="2015">2015</option>
                <option value="2016">2016</option>
                <option value="2017">2017</option>
                <option value="2018">2018</option>
                <option value="2019">2019</option>
                <option value="2020">2020</option>
                <option value="2021">2021</option>
                <option value="2022">2022</option>
                <option value="2023">2023</option>
                <option value="2024">2024</option>
            </select>
            <button id="continue-btn">Continue</button>
        </div>
    </div>

    <!-- Section 1: Birth Year -->
    <div class="scroll-section" id="section-birth">
        <div class="content-container">
            <div class="chart-side">
                <div class="chart-wrapper">
                    <svg id="chart-birth"></svg>
                </div>
            </div>
            <div class="text-side">
                <div class="text-content">
                    <h2>The Year You Were Born</h2>
                    <p id="birth-text">In <span id="birth-year-text"></span>, Mexico recorded</p>
                    <div class="stat" id="birth-stat"></div>
                    <p>This was the state of violence when you entered the world.</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Section 2: Drug War -->
    <div class="scroll-section" id="section-drugwar">
        <div class="content-container">
            <div class="chart-side">
                <div class="chart-wrapper">
                    <svg id="chart-drugwar"></svg>
                </div>
            </div>
            <div class="text-side">
                <div class="text-content">
                    <h2>The Drug War Begins</h2>
                    <p>Starting in 2006, the government launched a military crackdown on drug cartels. 
                    The strategy backfired catastrophically.</p>
                    <p>By 2011, homicides had exploded to unprecedented levels.</p>
                    <div class="stat">27,213 homicides</div>
                    <p>This was the peak of the first wave—more than <span id="drugwar-increase"></span> from your birth year.</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Section 3: Full Picture -->
    <div class="scroll-section" id="section-full">
        <div class="content-container">
            <div class="chart-side">
                <div class="chart-wrapper">
                    <svg id="chart-full"></svg>
                </div>
            </div>
            <div class="text-side">
                <div class="text-content">
                    <h2>The Full Story</h2>
                    <p>After a brief decline, violence surged again. 2020 became the deadliest year in modern Mexican history.</p>
                    <div class="stat">36,773 homicides</div>
                    <p>Today, violence remains at historically high levels. The crisis continues to devastate communities across Mexico.</p>
                    <p style="margin-top: 30px; padding-top: 30px; border-top: 2px solid #eee;">
                        The area in red represents your lifetime every year since you were born.
                    </p>
                </div>
            </div>
        </div>
    </div>

    <!-- Section 4: Cumulative Deaths -->
    <div class="scroll-section" id="section-cumulative">
        <div class="content-container">
            <div class="chart-side">
                <div class="chart-wrapper">
                    <svg id="chart-cumulative"></svg>
                </div>
            </div>
            <div class="text-side">
                <div class="text-content">
                    <h2>In Your Lifetime</h2>
                    <p>Since you were born in <span id="cumulative-year"></span>, this many people have been murdered in Mexico:</p>
                    <div class="cumulative-stat" id="cumulative-total"></div>
                    <p class="cumulative-note">That's <span id="cumulative-daily"></span> people per day, every day, for your entire life.</p>
                    <p style="margin-top: 40px; font-weight: 600; font-size: 1.3rem; color: #333;">
                        This is not normal. Every number represents a life lost, a family destroyed, a community traumatized.
                    </p>
                </div>
            </div>
        </div>
    </div>

    <!-- Section 5: Age Analysis -->
    <div class="scroll-section" id="section-age">
        <div class="content-container">
            <div class="chart-side">
                <div class="chart-wrapper">
                    <svg id="chart-age"></svg>
                </div>
            </div>
            <div class="text-side">
                <div class="text-content">
                    <h2>People Like You</h2>
                    <p>Violence doesn't discriminate by age, but some groups bear the heaviest burden.</p>
                    <p>Since you were born in <span id="age-birth-year"></span>, this many people in your age group have been murdered:</p>
                    <div class="cumulative-stat" id="age-total"></div>
                    <p class="cumulative-note">That's people who were <span id="age-range-text"></span> years old when they died.</p>
                </div>
            </div>
        </div>
    </div>

    <div style="height: 100vh;"></div>

    <script src="https://d3js.org/d3.v6.js"></script>
    <script>
        const homicideData = [
            {"Year":1990,"Total":14493.0},
            {"Year":1991,"Total":15128.0},
            {"Year":1992,"Total":16594.0},
            {"Year":1993,"Total":16040.0},
            {"Year":1994,"Total":15839.0},
            {"Year":1995,"Total":15612.0},
            {"Year":1996,"Total":14505.0},
            {"Year":1997,"Total":13552.0},
            {"Year":1998,"Total":13656.0},
            {"Year":1999,"Total":12249.0},
            {"Year":2000,"Total":10737.0},
            {"Year":2001,"Total":10285.0},
            {"Year":2002,"Total":10088.0},
            {"Year":2003,"Total":10087.0},
            {"Year":2004,"Total":9329.0},
            {"Year":2005,"Total":9921.0},
            {"Year":2006,"Total":10452.0},
            {"Year":2007,"Total":8867.0},
            {"Year":2008,"Total":14006.0},
            {"Year":2009,"Total":19803.0},
            {"Year":2010,"Total":25757.0},
            {"Year":2011,"Total":27213.0},
            {"Year":2012,"Total":25967.0},
            {"Year":2013,"Total":23063.0},
            {"Year":2014,"Total":20010.0},
            {"Year":2015,"Total":20762.0},
            {"Year":2016,"Total":24559.0},
            {"Year":2017,"Total":32079.0},
            {"Year":2018,"Total":36685.0},
            {"Year":2019,"Total":36661.0},
            {"Year":2020,"Total":36773.0},
            {"Year":2021,"Total":35700.0},
            {"Year":2022,"Total":33287.0},
            {"Year":2023,"Total":32252.0},
            {"Year":2024,"Total":33550.0}
        ];

        const data = homicideData.map((d) => ({
            year: d.Year,
            date: new Date(d.Year, 0, 1),
            value: d.Total,
        }));

        let birthYear = null;

        let ageData = [];

        d3.csv("homicides_by_age.csv").then(function(data) {
            ageData = data.map(d => {
                const keys = Object.keys(d);
                const result = {
                    year: +d[keys[0]],
                    total: +d["Total"]
                };

                // Add all age group columns
                keys.forEach(key => {
                    if (key !== keys[0] && key !== 'Total') {
                        result[key.trim()] = +d[key];  // trim() removes any spaces
                    }
                });
                
                return result;
            });
    
            console.log("✅ Age data loaded successfully!");
            console.log("Sample row:", ageData[0]);
            console.log("All keys:", Object.keys(ageData[0]));
        });

        // Setup
        document.getElementById('year-select').addEventListener('change', function() {
            if (this.value) {
                document.getElementById('continue-btn').style.display = 'block';
            }
        });

        document.getElementById('continue-btn').addEventListener('click', function() {
            birthYear = +document.getElementById('year-select').value;
            
            // Check if data is ready before scrolling
            if (ageData.length > 0) {
                setupScrollAnimations();
                document.getElementById('section-birth').scrollIntoView({ behavior: 'smooth' });
            } else {
                console.log("⏳ Waiting for age data to load...");
                // Wait for data, then proceed
                const checkData = setInterval(() => {
                    if (ageData.length > 0) {
                        clearInterval(checkData);
                        setupScrollAnimations();
                        document.getElementById('section-birth').scrollIntoView({ behavior: 'smooth' });
                        console.log("✅ Age data ready!");
                    }
                }, 100);
            }
        });

        function setupScrollAnimations() {
            const sections = document.querySelectorAll('.scroll-section');
            
            const observer = new IntersectionObserver((entries) => {
                entries.forEach(entry => {
                    if (entry.isIntersecting) {
                        entry.target.classList.add('visible');
                        
                        // Trigger animations based on section
                        if (entry.target.id === 'section-birth') {
                            drawBirthChart();
                        } else if (entry.target.id === 'section-drugwar') {
                            drawDrugWarChart();
                        } else if (entry.target.id === 'section-full') {
                            drawFullChart();
                        } else if (entry.target.id === 'section-cumulative') {
                            drawCumulativeChart();
                        } else if (entry.target.id === 'section-cumulative') {
                        drawCumulativeChart();
                        } else if (entry.target.id === 'section-age') {
                        drawAgeChart();
                        }
                    }
                });
            }, { threshold: 0.5 });

            sections.forEach(section => observer.observe(section));
        }

        function createScales(data, width, height) {
            const x = d3.scaleTime()
                .domain(d3.extent(data, d => d.date))
                .range([0, width]);

            const y = d3.scaleLinear()
                .domain([0, d3.max(data, d => d.value)])
                .nice()
                .range([height, 0]);

            return { x, y };
        }

        function drawBirthChart() {
            const margin = { top: 20, right: 30, bottom: 40, left: 60 };
            const width = 500 - margin.left - margin.right;
            const height = 400 - margin.top - margin.bottom;

            const svg = d3.select("#chart-birth")
                .attr("width", width + margin.left + margin.right)
                .attr("height", height + margin.top + margin.bottom)
                .append("g")
                .attr("transform", `translate(${margin.left},${margin.top})`);

            const filteredData = data.filter(d => d.year <= birthYear);
            const { x, y } = createScales(data, width, height);

            // Axes
            svg.append("g")
                .attr("transform", `translate(0,${height})`)
                .call(d3.axisBottom(x).ticks(6).tickFormat(d3.timeFormat("%Y")));

            svg.append("g")
                .call(d3.axisLeft(y).tickFormat(d => d.toLocaleString()));

            // Line
            const line = d3.line()
                .x(d => x(d.date))
                .y(d => y(d.value))
                .curve(d3.curveMonotoneX);

            const path = svg.append("path")
                .datum(filteredData)
                .attr("fill", "none")
                .attr("stroke", "steelblue")
                .attr("stroke-width", 3)
                .attr("d", line);

            // Animate line drawing
            const totalLength = path.node().getTotalLength();
            path
                .attr("stroke-dasharray", totalLength + " " + totalLength)
                .attr("stroke-dashoffset", totalLength)
                .transition()
                .duration(2000)
                .ease(d3.easeLinear)
                .attr("stroke-dashoffset", 0);

            // Highlight end point
            const endPoint = filteredData[filteredData.length - 1];
            svg.append("circle")
                .attr("cx", x(endPoint.date))
                .attr("cy", y(endPoint.value))
                .attr("r", 0)
                .attr("fill", "#e74c3c")
                .transition()
                .delay(2000)
                .duration(300)
                .attr("r", 6);

            // Update text
            document.getElementById('birth-year-text').textContent = birthYear;
            document.getElementById('birth-stat').textContent = endPoint.value.toLocaleString() + ' homicides';
        }

        function drawDrugWarChart() {
            const margin = { top: 20, right: 30, bottom: 40, left: 60 };
            const width = 500 - margin.left - margin.right;
            const height = 400 - margin.top - margin.bottom;

            const svg = d3.select("#chart-drugwar")
                .attr("width", width + margin.left + margin.right)
                .attr("height", height + margin.top + margin.bottom)
                .append("g")
                .attr("transform", `translate(${margin.left},${margin.top})`);

            const filteredData = data.filter(d => d.year <= 2011);
            const { x, y } = createScales(data, width, height);

            svg.append("g")
                .attr("transform", `translate(0,${height})`)
                .call(d3.axisBottom(x).ticks(6).tickFormat(d3.timeFormat("%Y")));

            svg.append("g")
                .call(d3.axisLeft(y).tickFormat(d => d.toLocaleString()));

            const line = d3.line()
                .x(d => x(d.date))
                .y(d => y(d.value))
                .curve(d3.curveMonotoneX);

            const path = svg.append("path")
                .datum(filteredData)
                .attr("fill", "none")
                .attr("stroke", "steelblue")
                .attr("stroke-width", 3)
                .attr("d", line);

            const totalLength = path.node().getTotalLength();
            path
                .attr("stroke-dasharray", totalLength + " " + totalLength)
                .attr("stroke-dashoffset", totalLength)
                .transition()
                .duration(2000)
                .ease(d3.easeLinear)
                .attr("stroke-dashoffset", 0);

            // Calculate increase
            const birthData = data.find(d => d.year === birthYear);
            const drugWarData = data.find(d => d.year === 2011);
            const increase = ((drugWarData.value - birthData.value) / birthData.value * 100).toFixed(0);
            document.getElementById('drugwar-increase').textContent = increase + '% higher';
        }

        function drawFullChart() {
            const margin = { top: 20, right: 30, bottom: 40, left: 60 };
            const width = 500 - margin.left - margin.right;
            const height = 400 - margin.top - margin.bottom;

            const svg = d3.select("#chart-full")
                .attr("width", width + margin.left + margin.right)
                .attr("height", height + margin.top + margin.bottom)
                .append("g")
                .attr("transform", `translate(${margin.left},${margin.top})`);

            const { x, y } = createScales(data, width, height);

            svg.append("g")
                .attr("transform", `translate(0,${height})`)
                .call(d3.axisBottom(x).ticks(6).tickFormat(d3.timeFormat("%Y")));

            svg.append("g")
                .call(d3.axisLeft(y).tickFormat(d => d.toLocaleString()));

            // Area before birth year (blue)
            const dataBefore = data.filter(d => d.year <= birthYear);
            const areaBeforeBirth = d3.area()
                .x(d => x(d.date))
                .y0(height)
                .y1(d => y(d.value))
                .curve(d3.curveMonotoneX);

            svg.append("path")
                .datum(dataBefore)
                .attr("fill", "steelblue")
                .attr("opacity", 0.3)
                .attr("d", areaBeforeBirth);

            // Area after birth year (red)
            const dataAfter = data.filter(d => d.year >= birthYear);
            const areaAfterBirth = d3.area()
                .x(d => x(d.date))
                .y0(height)
                .y1(d => y(d.value))
                .curve(d3.curveMonotoneX);

            svg.append("path")
                .datum(dataAfter)
                .attr("fill", "#e74c3c")
                .attr("opacity", 0.3)
                .attr("d", areaAfterBirth);

            // Full line
            const line = d3.line()
                .x(d => x(d.date))
                .y(d => y(d.value))
                .curve(d3.curveMonotoneX);

            const path = svg.append("path")
                .datum(data)
                .attr("fill", "none")
                .attr("stroke", "#333")
                .attr("stroke-width", 3)
                .attr("d", line);

            const totalLength = path.node().getTotalLength();
            path
                .attr("stroke-dasharray", totalLength + " " + totalLength)
                .attr("stroke-dashoffset", totalLength)
                .transition()
                .duration(3000)
                .ease(d3.easeLinear)
                .attr("stroke-dashoffset", 0);
        }

        function drawCumulativeChart() {
            // Calculate cumulative total
            const dataAfterBirth = data.filter(d => d.year >= birthYear);
            const cumulativeTotal = dataAfterBirth.reduce((sum, d) => sum + d.value, 0);
            const years = 2024 - birthYear + 1;
            const dailyAverage = Math.round(cumulativeTotal / (years * 365));

            document.getElementById('cumulative-year').textContent = birthYear;
            document.getElementById('cumulative-total').textContent = cumulativeTotal.toLocaleString();
            document.getElementById('cumulative-daily').textContent = dailyAverage.toLocaleString();

            // Draw cumulative bar chart
            const margin = { top: 20, right: 30, bottom: 60, left: 60 };
            const width = 500 - margin.left - margin.right;
            const height = 400 - margin.top - margin.bottom;

            const svg = d3.select("#chart-cumulative")
                .attr("width", width + margin.left + margin.right)
                .attr("height", height + margin.top + margin.bottom)
                .append("g")
                .attr("transform", `translate(${margin.left},${margin.top})`);

            const x = d3.scaleBand()
                .domain(dataAfterBirth.map(d => d.year))
                .range([0, width])
                .padding(0.1);

            const y = d3.scaleLinear()
                .domain([0, d3.max(dataAfterBirth, d => d.value)])
                .nice()
                .range([height, 0]);

            svg.append("g")
                .attr("transform", `translate(0,${height})`)
                .call(d3.axisBottom(x).tickValues(x.domain().filter((d, i) => i % 3 === 0)));

            svg.append("g")
                .call(d3.axisLeft(y).tickFormat(d => d.toLocaleString()));

            svg.selectAll(".bar")
                .data(dataAfterBirth)
                .enter()
                .append("rect")
                .attr("class", "bar")
                .attr("x", d => x(d.year))
                .attr("y", height)
                .attr("width", x.bandwidth())
                .attr("height", 0)
                .attr("fill", "#e74c3c")
                .transition()
                .duration(1500)
                .delay((d, i) => i * 50)
                .attr("y", d => y(d.value))
                .attr("height", d => height - y(d.value));
        }

        function getCurrentAgeGroup(birthYear) {
            const currentAge = (2024 - birthYear) + 1;
            
            if (currentAge >= 0 && currentAge <= 4) return "0-4 anos";
            if (currentAge >= 5 && currentAge <= 9) return "5-9 anos";
            if (currentAge >= 10 && currentAge <= 14) return "10-14 anos";
            if (currentAge >= 15 && currentAge <= 19) return "15-19 anos";
            if (currentAge >= 20 && currentAge <= 24) return "20-24 anos";
            if (currentAge >= 25 && currentAge <= 29) return "25-29 anos";
            if (currentAge >= 30 && currentAge <= 34) return "30-34 anos";
            if (currentAge >= 35 && currentAge <= 39) return "35-39 anos";
            if (currentAge >= 40 && currentAge <= 44) return "40-44 anos";
            if (currentAge >= 45 && currentAge <= 49) return "45-49 anos";
            if (currentAge >= 50 && currentAge <= 54) return "50-54 anos";
            if (currentAge >= 55 && currentAge <= 59) return "55-59 anos";
            if (currentAge >= 60 && currentAge <= 64) return "60-64 anos";
            if (currentAge >= 65 && currentAge <= 69) return "65-69 anos";
            if (currentAge >= 70 && currentAge <= 74) return "70-74 anos";
            if (currentAge >= 75 && currentAge <= 79) return "75-79 anos";
            if (currentAge >= 80 && currentAge <= 84) return "80-84 anos";
            if (currentAge >= 85) return "85 anos y mas";

        }

        function calculateAgeGroupDeaths(birthYear) {
            const ageGroup = getCurrentAgeGroup(birthYear);
            
            console.log("Looking for age group:", ageGroup);
            console.log("Available keys:", Object.keys(ageData[0]));
            
            // Filter data from birthYear onwards
            const relevantData = ageData.filter(d => d.year >= birthYear);
            
            // Sum up deaths in that age group
            const total = relevantData.reduce((sum, d) => sum + (d[ageGroup] || 0), 0);
            
            // Also return yearly breakdown for the chart
            const yearlyData = relevantData.map(d => ({
                year: d.year,
                deaths: d[ageGroup] || 0
            }));
            
            return { total, yearlyData, ageGroup };
        }

        function drawAgeChart() {
            // Get the data
            const result = calculateAgeGroupDeaths(birthYear);
            const total = result.total;
            
            // How many people each silhouette represents
            const PEOPLE_PER_ICON = 500;
            const numIcons = Math.ceil(total / PEOPLE_PER_ICON);
            
            console.log(`Creating ${numIcons} silhouettes (${PEOPLE_PER_ICON} people each)`);
            
            // Clear any existing content
            d3.select("#chart-age").selectAll("*").remove();
            
            // Container dimensions
            const containerWidth = 500;
            const containerHeight = 400;
            const iconSize = 20;
            const iconSpacing = 5;
            
            const iconsPerRow = Math.floor(containerWidth / (iconSize + iconSpacing));
            const numRows = Math.ceil(numIcons / iconsPerRow);
            
            const svg = d3.select("#chart-age")
                .attr("width", containerWidth)
                .attr("height", containerHeight)
                .attr("viewBox", `0 0 ${containerWidth} ${containerHeight}`);
            
            // Create silhouette data array
            const silhouettes = [];
            for (let i = 0; i < numIcons; i++) {
                const row = Math.floor(i / iconsPerRow);
                const col = i % iconsPerRow;
                silhouettes.push({
                    x: col * (iconSize + iconSpacing) + iconSize / 2,
                    y: row * (iconSize + iconSpacing) + iconSize / 2,
                    index: i
                });
            }
            
            // Draw silhouettes
            svg.selectAll(".silhouette")
                .data(silhouettes)
                .enter()
                .append("path")
                .attr("class", "silhouette")
                .attr("d", "M12 12c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm0 2c-2.67 0-8 1.34-8 4v2h16v-2c0-2.66-5.33-4-8-4z")
                .attr("transform", d => `translate(${d.x - 12}, ${d.y - 12}) scale(${iconSize / 24})`)
                .attr("fill", "#e74c3c")
                .attr("opacity", 0)
                .transition()
                .duration(30)
                .delay(d => d.index * 10) // Stagger animation
                .attr("opacity", 0.7);
            
            // Add legend
            svg.append("text")
                .attr("x", containerWidth / 2)
                .attr("y", containerHeight - 10)
                .attr("text-anchor", "middle")
                .attr("font-size", "11px")
                .attr("fill", "#666")
                .style("font-family", "italic")
                .text("* Each sillhouette represents " + PEOPLE_PER_ICON.toLocaleString() + " people");
            
            // Update text elements
            const currentAge = 2024 - birthYear;
            document.getElementById('age-birth-year').textContent = birthYear;
            document.getElementById('age-total').textContent = result.total.toLocaleString();
            document.getElementById('age-range-text').textContent = `${currentAge - 4}-${currentAge}`;
        }
    </script>
</body>
</html>